<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equity Path Forecaster | Camac Consulting</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #ffffff; padding: 15px; color: #333; margin: 0; }
        .container { max-width: 900px; margin: auto; padding-bottom: 140px; } 
        
        .header-area { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #f4f7f9; padding-bottom: 15px; }
        .header-area h1 { font-size: 24px; color: #001935; margin: 0; letter-spacing: -0.5px; text-transform: uppercase; }
        .header-area .brand-subtitle { font-size: 10px; color: #41797e; font-weight: bold; text-transform: uppercase; margin-top: 5px; letter-spacing: 2px; }
        .header-area p.tagline { font-size: 12px; color: #666; margin-top: 4px; font-style: italic; }

        .stats-bar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-card { background: #41797e; color: white; padding: 18px; border-radius: 10px; text-align: center; border: 1px solid rgba(0,0,0,0.05); position: relative; }
        .stat-card.dark { background: #001935; }
        .stat-card h2 { margin: 5px 0 0 0; font-size: 24px; }
        .stat-card p { margin: 0; font-size: 10px; text-transform: uppercase; font-weight: bold; opacity: 0.8; }

        /* Status Light Styling */
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; position: absolute; top: 12px; right: 12px; background: #666; transition: 0.3s; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .status-online { background: #4ade80; box-shadow: 0 0 8px #4ade80; }
        .status-offline { background: #f87171; box-shadow: 0 0 8px #f87171; }

        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; background: #f4f7f9; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .control-group { display: flex; flex-direction: column; }
        label { font-weight: bold; font-size: 10px; color: #001935; text-transform: uppercase; display: block; margin-bottom: 4px; }
        input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        .input-hint { font-size: 9px; font-style: italic; color: #666; line-height: 1.2; margin-top: 5px; display: block; min-height: 22px; }

        .btn-group { grid-column: 1 / -1; display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        button { padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; font-size: 11px; }
        #runBtn { background: #001935; color: white; }
        #exportBtn { background: #41797e; color: white; }
        #probBtn { background: #64748b; color: white; }
        button:hover { opacity: 0.9; }

        .chart-container { height: 380px; margin-bottom: 25px; position: relative; background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 10px; }
        #loader { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; text-align: center; }
        .spinner { width: 35px; height: 35px; border: 4px solid #f3f3f3; border-top: 4px solid #41797e; border-radius: 50%; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: #001935; color: white; padding: 10px; text-align: left; text-transform: uppercase; letter-spacing: 0.5px; }
        td { border: 1px solid #eee; padding: 10px; }
        tr:nth-child(even) { background: #fafafa; }
        
        .footer-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; padding: 15px 0; border-top: 1px solid #ddd; text-align: center; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .footer-nav a.view-btn { color: #ffffff; background-color: #41797e; font-weight: bold; text-decoration: none; font-size: 13px; display: inline-block; padding: 10px 20px; border-radius: 6px; transition: 0.3s; margin-bottom: 8px; }
        .powered-by { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #999; font-weight: bold; }
        .powered-by a { color: #41797e; text-decoration: none; border-bottom: 1px solid transparent; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-area">
        <h1>Equity Path Forecaster</h1>
        <div class="brand-subtitle">Powered by Camac Consulting</div>
        <p class="tagline">Quantitative Price Simulation Engine</p>
    </div>

    <div class="stats-bar">
        <div class="stat-card dark">
            <div id="statusLight" class="status-indicator"></div>
            <p id="tickerLabel">Current Price</p>
            <h2 id="livePrice">---</h2>
        </div>
        <div class="stat-card">
            <p id="probLabel">Prob. of Meeting Target</p>
            <h2 id="probDisplay">--%</h2>
        </div>
        <div class="stat-card">
            <p>90th Percentile Target</p>
            <h2 id="targetDisplay">---</h2>
        </div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>Stock Ticker</label>
            <input type="text" id="symbol" value="VOO">
            <span class="input-hint">Market symbol (e.g. AAPL, VOO).</span>
        </div>
        <div class="control-group">
            <label>Forecast Days</label>
            <input type="number" id="days" value="30">
            <span class="input-hint">Length of time for projection.</span>
        </div>
        <div class="control-group">
            <label>Simulations</label>
            <input type="number" id="sims" value="1000">
            <span class="input-hint">Quantity of random paths generated.</span>
        </div>
        <div class="control-group">
            <label>Bias (Drift %)</label>
            <input type="number" id="drift" value="0.05" step="0.01">
            <span class="input-hint">Assumed annual "pull" of the stock.</span>
        </div>
        <div class="control-group">
            <label>Price Goal ($)</label>
            <input type="number" id="priceTarget" value="560">
            <span class="input-hint">Target to calculate probability.</span>
        </div>
        
        <div class="btn-group">
            <button id="runBtn" onclick="analyzeAndRun()">Generate Forecast</button>
            <button id="exportBtn" onclick="downloadCSV()">Export CSV</button>
            <button id="probBtn" onclick="calculateProbability()">Update Goal</button>
        </div>
    </div>

    <div class="chart-container">
        <div id="loader"><div class="spinner"></div><p style="font-size:10px; margin-top:10px; font-weight:bold;">SEARCHING DATASET...</p></div>
        <canvas id="mainChart"></canvas>
    </div>

    <table id="dataTable">
        <thead><tr><th>Forecast Interval</th><th>Bearish Case (10th)</th><th>Median Case (50th)</th><th>Bullish Case (90th)</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<div class="footer-nav">
    <a href="javascript:void(0);" onclick="window.open(window.location.href, '_blank');" class="view-btn">VIEW FULL SCREEN â†—</a>
    <div class="powered-by">Analytics by <a href="https://github.com/CamacConsulting/EquityPathForecaster" target="_blank">Camac Consulting</a></div>
</div>

<script>
let chart;
let currentResults = { allPaths: [], p10: [], p50: [], p90: [], labels: [] };
const apiKey = '6PQ2Z7ZB4JQDZ3LS';

async function analyzeAndRun() {
    const symbol = document.getElementById('symbol').value.toUpperCase();
    const loader = document.getElementById('loader');
    const btn = document.getElementById('runBtn');
    const light = document.getElementById('statusLight');

    loader.style.display = 'block';
    btn.disabled = true;
    light.className = 'status-indicator'; // Reset light

    try {
        // Step 1: Try Historical Daily Data
        const response = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${apiKey}`);
        const data = await response.json();
        
        if (data["Note"]) {
            alert("API limit reached (5 per min / 25 per day).");
            throw new Error("Limit");
        }

        let currentPrice;
        let dailyVol = 0.018; 

        if (data["Time Series (Daily)"]) {
            const timeSeries = data["Time Series (Daily)"];
            const prices = Object.values(timeSeries).map(d => parseFloat(d["4. close"])).reverse();
            currentPrice = prices[prices.length - 1];

            let returns = [];
            for (let i = 1; i < prices.length; i++) {
                returns.push(Math.log(prices[i] / prices[i-1]));
            }
            const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
            const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / (returns.length - 1);
            dailyVol = Math.sqrt(variance);
            light.classList.add('status-online');
        } else {
            // Step 2: Fallback to Global Quote (Crucial for ETFs)
            const quoteRef = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKey}`);
            const quoteData = await quoteRef.json();
            
            if (quoteData["Global Quote"] && quoteData["Global Quote"]["05. price"]) {
                currentPrice = parseFloat(quoteData["Global Quote"]["05. price"]);
                light.classList.add('status-online');
            } else {
                throw new Error("Not Found");
            }
        }

        document.getElementById('livePrice').innerText = `$${currentPrice.toFixed(2)}`;
        document.getElementById('tickerLabel').innerText = `${symbol} CURRENT`;
        runMonteCarlo(currentPrice, dailyVol);

    } catch (e) {
        light.classList.add('status-offline');
        document.getElementById('tickerLabel').innerText = `ERROR / DEMO`;
        runMonteCarlo(135.50, 0.021); 
    } finally {
        loader.style.display = 'none';
        btn.disabled = false;
    }
}

function runMonteCarlo(startPrice, vol) {
    const days = parseInt(document.getElementById('days').value);
    const sims = parseInt(document.getElementById('sims').value);
    const drift = parseFloat(document.getElementById('drift').value) / 100;

    let results = Array.from({length: days + 1}, () => []);

    for (let s = 0; s < sims; s++) {
        let p = startPrice;
        results[0].push(p);
        for (let t = 1; t <= days; t++) {
            const val = (drift - 0.5 * Math.pow(vol, 2)) + (vol * boxMuller());
            p *= Math.exp(val);
            results[t].push(p);
        }
    }
    updateUI(results, days, sims);
}

function boxMuller() {
    let u = 0, v = 0;
    while(u === 0) u = Math.random();
    while(v === 0) v = Math.random();
    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function updateUI(results, days, sims) {
    let labels = [], p10 = [], p50 = [], p90 = [], rows = "";
    const i10 = Math.floor(sims * 0.1), i50 = Math.floor(sims * 0.5), i90 = Math.floor(sims * 0.9);

    for (let t = 0; t <= days; t++) {
        results[t].sort((a,b) => a-b);
        labels.push(`Day ${t}`);
        p10.push(results[t][i10]); p50.push(results[t][i50]); p90.push(results[t][i90]);
        if (t % 5 === 0 || t === days) {
            rows += `<tr><td>Day ${t}</td><td>$${p10[t].toFixed(2)}</td><td>$${p50[t].toFixed(2)}</td><td>$${p90[t].toFixed(2)}</td></tr>`;
        }
    }

    currentResults = { allPaths: results[days], p10, p50, p90, labels, symbol: document.getElementById('symbol').value.toUpperCase() };
    document.getElementById('targetDisplay').innerText = `$${p90[days].toFixed(2)}`;
    document.querySelector("#dataTable tbody").innerHTML = rows;
    calculateProbability();

    if (chart) chart.destroy();
    chart = new Chart(document.getElementById('mainChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                { label: 'Median Projection', data: p50, borderColor: '#41797e', borderWidth: 3, fill: false, pointRadius: 0 },
                { label: 'Bullish (90th)', data: p90, borderColor: '#001935', backgroundColor: 'rgba(0, 25, 53, 0.05)', fill: 2, pointRadius: 0 },
                { label: 'Bearish (10th)', data: p10, borderColor: '#ccc', borderDash: [5,5], fill: false, pointRadius: 0 }
            ]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { legend: { display: true, position: 'bottom' } },
            scales: { y: { ticks: { callback: v => '$' + v.toLocaleString() } } }
        }
    });
}

function calculateProbability() {
    const target = parseFloat(document.getElementById('priceTarget').value);
    const finalPrices = currentResults.allPaths;
    if (!finalPrices.length) return;
    const successes = finalPrices.filter(p => p >= target).length;
    const prob = ((successes / finalPrices.length) * 100).toFixed(1);
    document.getElementById('probDisplay').innerText = prob + "%";
    document.getElementById('probLabel').innerText = `Prob. of $${target}+`;
}

function downloadCSV() {
    if (!currentResults.labels.length) return;
    let csvContent = "data:text/csv;charset=utf-8,Day,Bearish,Median,Bullish\n";
    currentResults.labels.forEach((label, i) => {
        csvContent += `${label},${currentResults.p10[i].toFixed(4)},${currentResults.p50[i].toFixed(4)},${currentResults.p90[i].toFixed(4)}\n`;
    });
    const link = document.createElement("a");
    link.setAttribute("href", encodeURI(csvContent));
    link.setAttribute("download", `Forecast_${currentResults.symbol}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

window.onload = analyzeAndRun;
</script>
</body>
</html>
